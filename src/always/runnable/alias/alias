#!/usr/bin/env zsh
# --------------------( LICENSE                            )--------------------
# Copyright 2007-2013 by Cecil Curry.
# See "COPYING" for additional details.

declare_parcel_as_script_with_stdin <<'-/-'
Handle core alias functionality.
-/-

# ....................{ EXCEPTIONS                         }....................
declare_function_with_stdin <<'/---'
void die_unless_alias(
    string alias_name,
    string error_message = "alias \"${alias_name}\" not found")

Throw an exception with the passed message unless the passed alias exists. See
is_alias() for further details.
/---
function die_unless_alias() {
    die_unless_args_1_to_2 'expected one alias name and optional error message'
    string alias_name="${1}"
    is_alias "${alias_name}" or die "${2:-alias \"${alias_name}\" not found}"
}

declare_function_with_stdin <<'/---'
void die_unless_alias_normal(
    string alias_name,
    string error_message = "normal alias \"${alias_name}\" not found")

Throw an exception with the passed message unless the passed alias is an
existing normal alias. See is_alias_normal() for further details.
/---
function die_unless_alias_normal() {
    die_unless_args_1_to_2 'expected one alias name and optional error message'
    string alias_name="${1}"
    is_alias_normal "${alias_name}" or
        die "${2:-normal alias \"${alias_name}\" not found}"
}

declare_function_with_stdin <<'/---'
void die_unless_alias_global(
    string alias_name,
    string error_message = "global alias \"${alias_name}\" not found")

Throw an exception with the passed message unless the passed alias is an
existing global alias. See is_alias_global() for further details.
/---
function die_unless_alias_global() {
    die_unless_args_1_to_2 'expected one alias name and optional error message'
    string alias_name="${1}"
    is_alias_global "${alias_name}" or
        die "${2:-global alias \"${alias_name}\" not found}"
}

# ....................{ TESTERS                            }....................
declare_function_with_stdin <<'/---'
[status: boolean] is_alias(string alias_name1, string alias_name2, ...)

Return success if all passed aliases exist. Specifically, each such alias must
be either an existing normal, global, or suffix alias.
/---
function is_alias() {
    # Validate passed arguments.
    die_unless_args 'expected at least one alias name'

    # Sadly, alias() explicitly requires option "-s" for testing suffix aliases
    # and no such option for testing normal and global aliases. Hence, iterate
    # such aliases and manually apply such options.
    string alias_name
    for    alias_name ("${@}") {
        # Since normal and global aliases are considerably more common than
        # suffix aliases, test the former first. For efficiency, inline such
        # implementation. See is_alias_nonsuffix() and is_alias_suffix() for
        # further details.
        alias -- "${alias_name}" or alias -s -- "${alias_name}" or return_false
    }

    # All such aliases exist. Return jubilation.
    return_true
}

declare_function_with_stdin <<'/---'
[status: boolean] is_alias_normal(string alias_name1, string alias_name2, ...)

Return success if all passed aliases are existing *normal aliases* (i.e.,
aliases expanded only in command position).
/---
function is_alias_normal() {
    # Validate sanity.
    die_unless_args 'expected at least one alias name'
    is_map_key aliases "${@}"
}

declare_function_with_stdin <<'/---'
[status: boolean] is_alias_global(string alias_name1, string alias_name2, ...)

Return success if all passed aliases are existing *global aliases* (i.e.,
aliases expanded in _all_ positions, not merely command position).
/---
function is_alias_global() {
    die_unless_args 'expected at least one alias name'
    is_map_key galiases "${@}"
}

declare_function_with_stdin <<'/---'
[status: boolean] is_alias_nonsuffix(
    string alias_name1, string alias_name2, ...)

Return success if all passed aliases are existing *non-suffix aliases*
(i.e., normal or global aliases). See is_alias_normal() and is_alias_global()
for further details.
/---
function is_alias_nonsuffix() {
    die_unless_args 'expected at least one alias name'
    run_command_silent alias -- "${@}"
}

# ....................{ GETTERS                            }....................
declare_function_with_stdin <<'/---'
string get_alias_expansion(string alias_name)

Get the expansion to which the passed alias expands: e.g.,

.get_alias_expansion()
==========================================
[source]
------------------------------------------
>>> alias on_idleness='print_string\
...    "Suppose that, at a given moment, a certain number of people are engaged
...     in the manufacture of pins. They make as many pins as the world needs,
...     working (say) eight hours a day. Someone makes an invention by which the
...     same number of men can make twice as many pins: pins are already so
...     cheap that hardly any more will be bought at a lower price. In a
...     sensible world, everybody concerned in the manufacturing of pins would
...     take to working four hours instead of eight, and everything else would
...     go on as before. But in the actual world this would be thought
...     demoralizing. The men still work eight hours, there are too many pins,
...     some employers go bankrupt, and half the men previously concerned in
...     making pins are thrown out of work. There is, in the end, just as much
...     leisure as on the other plan, but half the men are totally idle while
...     half are still overworked. In this way, it is insured that the
...     unavoidable leisure shall cause misery all round instead of being a
...     universal source of happiness. Can anything more insane be imagined?"'
>>> get_string_line "$(get_alias_expansion on_idleness)" -1
universal source of happiness. Can anything more insane be imagined?
------------------------------------------
==========================================
/---
function get_alias_expansion() {
    # Validate passed arguments.
    die_unless_arg 'expected one alias name'
    string alias_name="${1}"
    die_unless_alias "${alias_name}"

    #FIXME: Given the name of this function, this should transparently work for
    #suffix aliases, too. I'm fairly certain it doesn't, however. Amend!

    # Get such expansion. Happily, this is remarkably straight-forward.
    whence -- "${alias_name}"
}

declare_function_with_stdin <<'/---'
string get_alias_nonsuffix_binding(
    string alias_name1, string alias_name2, ...)

Get *bindings* (i.e., declarations with definitions) for all passed aliases, in
the passed order: e.g.,

.get_alias_nonsuffix_binding()
==========================================
[source]
------------------------------------------
>>> alias_global on_hard_landings='print_string\
...    "Energy has always been the basis of cultural complexity and it always
...     will be. The past clarifies potential paths to the future. One often-
...     discussed path is cultural and economic simplicity and lower energy
...     costs. This could come about through the \"crash\" that many fear - a
...     genuine collapse over a period of one or two generations, with much
...     violence, starvation, and loss of population."'
>>> alias on_soft_landings='print_string\
...    "The alternative is the \"soft landing\" that many people hope for - a
...     voluntary change to solar energy and green fuels, energy-conserving
...     technologies and less overall consumption. This is a utopian alternative
...     that, as suggested above, will come about only if severe, prolonged
...     hardship in industrial nations makes it attractive, and if economic
...     growth and consumerism can be removed from the realm of ideology."'
>>> get_string_lines_matching_glob "$(get_alias_nonsuffix_binding\
...     on_hard_landings on_soft_landings)" ('alias'|[[:space:]]#'"')*
alias -g on_hard_landings='print_string\
   "Energy has always been the basis of cultural complexity and it always
alias on_soft_landings='print_string\
   "The alternative is the \"soft landing\" that many people hope for - a
------------------------------------------
==========================================
/---
function get_alias_nonsuffix_binding() {
    die_unless_args 'expected one or more alias names'
    alias -L -- "${@}"
}

# ....................{ GETTERS ~ list                     }....................
declare_function_with_stdin <<'/---'
string get_aliases(void)

List all alias names, delimited by newline.
/---
function get_aliases() {
    die_if_args
    get_aliases_nonsuffix
    get_aliases_suffix
}

declare_function_with_stdin <<'/---'
string get_aliases_nonsuffix(void)

List all *normal and global alias* names (i.e., non-suffix alias names),
delimited by newline.
/---
function get_aliases_nonsuffix() {
    die_if_args
    alias +
}

# ....................{ SETTERS                            }....................
declare_function_with_stdin <<'/---'
void set_list_to_aliases(string list_name)

Set the passed list to all alias names.
/---
function set_list_to_aliases() {
    # Validate passed arguments.
    die_unless_arg 'expected one list name'
    string list_name__slta="${1}"
    die_unless_list "${list_name__slta}"

    # Set such list.
    set_list_to_string_lines "${list_name__slta}" "$(get_aliases)"
}

declare_function_with_stdin <<'/---'
void set_list_to_aliases_nonsuffix(string list_name)

Set the passed list to all normal and global alias (i.e., non-suffix alias)
names.
/---
function set_list_to_aliases_nonsuffix() {
    # Validate passed arguments.
    die_unless_arg 'expected one list name'
    string list_name__sltanag="${1}"
    die_unless_list "${list_name__sltanag}"

    # Set such list.
    set_list_to_string_lines\
        "${list_name__sltanag}" "$(get_aliases_nonsuffix)"
}

# ....................{ DEFINERS                           }....................
declare_function_with_stdin <<'/---'
void undefine_alias(string alias_name1, string alias_name2, ...)

Undefine the passed aliases.
/---
function undefine_alias() {
    # Validate passed arguments.
    die_unless_args 'expected at least one alias name'

    # Sadly, unhash() and hence unalias() explicitly require option "-s" for
    # removing suffix aliases and no such option for removing normal and global
    # aliases. Hence, iterate such aliases and manually apply such options.
    # For efficiency, avoid calling Zeshy functions.
    for aluas_name__ua ("${@}") {
        # If such alias is a non-suffix alias, undefine such alias as such. See
        # is_alias_nonsuffix() for further details.
        if { alias -- "${aluas_name__ua}" &>/dev/null } {
            unalias    -- "${aluas_name__ua}"
        # Else, such alias is a non-suffix alias. Undefine such alias as such.
        } else {
            unalias -s -- "${aluas_name__ua}"
        }
    }
}

declare_function_with_stdin <<'/---'
void undefine_alias_nonsuffix(
    string alias_name1, string alias_name2, ...)

Undefine the passed normal or global aliases (i.e., non-suffix aliases).
/---
function undefine_alias_nonsuffix() {
    die_unless_args 'expected at least one alias name'
    unalias    -- "${aluas_name__ua}"
}

# --------------------( WASTELANDS                         )--------------------
#FUXME: Truncate "nonsuffix" to simply "nonsuffix" everywhere.

#       is_alias_nonsuffix "${alias_name}" or
#       is_alias_suffix "${alias_name}" or
#           return_false
    #FUXME: Replace with a call to a new is_map_keys() function, which can be
    #efficiently implemented by embedding the entire loop in an "eval".
    # Test such aliases.
#   for alias_name ("${@}") {
#       (( ${+aliases[${alias_name}]} )) or return_false
#   }
#   return_true
    #FUXME: Generalize to accept multiple alias names. To do so, we'll want to
    #implement a new function is_map_keys() returning success only if all passed
    #keys exist in the passed map. This should be considerably faster than
    #performing an explicit loop. Such function may be implemented by noting
    #that "(( ${map[(i)(${(q)1}|...|${(q)@[-1]})]} <= ${#map} ))"
    #implements such test. I'm not quite sure about the "(q)"; however, we'll
    #certainly need some form of escaping. Right. "(q)" should do it, I think.
    #For efficiency, we certainly wouldn't want to call escape_string()
    #repeatedly. Unsure how to efficiently construct the list of keys, however.
    #Shouldn't be terribly hard; just contemplate it.

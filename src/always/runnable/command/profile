#!/usr/bin/env zsh
# ====================[ profile                            ]====================
#
# --------------------( LICENSE                            )--------------------
# Copyright 2007-2013 by Cecil Curry.
# See "COPYING" for additional details.
#
# --------------------( SYNOPSIS                           )--------------------
# Handle command profiling (i.e., timing, tracing) for performance testing.

# ....................{ RUNNERS                            }....................
document_function '
string run_command_profiled(
  string command_name, string command_arg1, string command_arg2, ...)

Run the passed command, profiled. After running such command, print a human-
readable profile of all zsh functions called by such command to standard
error to guarantee expected behavior under process substitution.
'
function run_command_profiled() {
    # Validate passed arguments.
    die_unless_args 'expected one command'

    # Temporarily load module "prof", thus initiating profiling.
    load_zsh_module zsh/prof

    {
        # Run such command.
        run_command "${@}"

        # Print such profile to standard error. Avoid calling
        # run_command_redirected_to_standard_error() to avoid slowing down profiling.
        zprof 1>&2
    # Always unload module "prof", thus terminating profiling.
    } always {
        unload_zsh_module zsh/prof
    }
}

# --------------------( WASTELANDS                         )--------------------

#!/usr/bin/env zsh
# ====================[ module                             ]====================
#
# --------------------( LICENSE                            )--------------------
# Copyright 2007-2012 by Cecil Curry.
# See "COPYING" for additional details.
#
# --------------------( SYNOPSIS                           )--------------------
# Handle *nix kernel modules.

# ....................{ ALIASES                            }....................
interactive_abbreviation {mod}ule{i}nfo='print_kernel_module'
interactive_abbreviation {mod}ule{s}='print_kernel_modules'
interactive_abbreviation {mod}ule{l}oad='load_kernel_module'
interactive_abbreviation {mod}ule{u}nload='unload_kernel_module'

# ....................{ PRINTERS                           }....................
# string print_kernel_module(string module_name1, string module_name2, ...)
#
# Print a human-readable profile of the passed kernel modules for the currently
# installed kernel.
print_kernel_module() {
    die_unless_args 'expected at least one module name'
    modinfo -- "${@}"
}

# string print_kernel_modules(string kernel_home = get_kernel_home())
#
# Print a human-readable synopsis of all currently loaded and loadable kernel
# modules for the passed kernel (defaulting to the currently installed kernel).
print_kernel_modules() {
    # Validate passed arguments.
    die_unless_args_0_to_1 'expected optional dirname'
    string kernel_home kernel_version
    kernel_home="${1:-$(get_kernel_home)}"
    kernel_version="$(get_kernel_version "${kernel_home}")"

    {
#       say_first_section 'printing currently loaded kernel modules...'
        say_first_section '[loaded kernel modules]'
        lsmod

        #FIXME: Not quite right. This prints builtin and non-builtin; we really only
        #want a print of non-builtin modules. Though there seems to exist no print of
        #the latter, file "modules.builtin" prints the former; hence, we could filter
        #the former from the print of returned modules.
        say_next_section '[loadable kernel modules]'
        list_path_recursively "/lib/modules/${kernel_version}/"**/*.ko
    } | run_paged
}

# ....................{ WRITERS                            }....................
# void load_kernel_module(string module_name1, string module_name2, ...)
#
# Load the passed kernel modules.
load_kernel_module() {
    die_unless_args 'expected at least one module name'
    modprobe -- "${@}"
}

# void unload_kernel_module(string module_name1, string module_name2, ...)
#
# Unload the passed kernel modules.
unload_kernel_module() {
    die_unless_args 'expected at least one module name'
    modprobe -r -- "${@}"
}

# --------------------( WASTELANDS                         )--------------------
# string print_loaded_kernel_modules(void)
#
# Print all currently loaded kernel modules.
#print_loaded_kernel_modules() {
#    die_if_args
#}

#!/usr/bin/env zsh
# ====================[ integer                            ]====================
#
# --------------------( LICENSE                            )--------------------
# Copyright 2007-2013 by Cecil Curry.
# See "COPYING" for additional details.
#
# --------------------( SYNOPSIS                           )--------------------
# Handle system time in integer format.

# ....................{ GETTERS                            }....................
declare_function_with_stdin <<'________________<heredoc?>________________'
integer get_time_unix(void)

Get the current time in seconds since the Unix epoch (January 1st, 1970): e.g.,

.get_time_unix()
==========================================
[source]
------------------------------------------
>>> get_time_unix
3141592653
------------------------------------------
==========================================
________________<heredoc?>________________
function get_time_unix() {
    die_if_args
    date +'%s'
}

declare_function_with_stdin <<'________________<heredoc?>________________'
integer get_time_unix_offset_by_hours(integer hour_offset)

Get the current time in seconds since the Unix epoch offset by the passed
positive or negative hour offset of either integer or float type: e.g.,

.get_time_unix_offset_by_hours()
==========================================
[source]
------------------------------------------
>>> get_time_unix
3141592653
>>> get_time_unix_offset_by_hours -6.5
3141569253
------------------------------------------
==========================================
________________<heredoc?>________________
function get_time_unix_offset_by_hours() {
    # Validate passed arguments.
    die_unless_arg 'expected one integer'
    string hour_offset="${1}"
    die_unless_integer "${hour_offset}"

    # Offset such time.
    return_string $((\
        $(get_time_unix) +\
        $(convert_hours_to_seconds ${hour_offset}) ))
}

# ....................{ GETTERS ~ period                   }....................
declare_function_with_stdin <<'________________<heredoc?>________________'
integer get_time_century(void)

Get the current century as a two-digit integer:

.get_time_century()
==========================================
[source]
------------------------------------------
>>> get_time_century
20
------------------------------------------
==========================================
________________<heredoc?>________________
function get_time_century() {
    die_if_args
    date +'%C'
}

declare_function_with_stdin <<'________________<heredoc?>________________'
integer get_time_year(void)

Get the current year as a four-digit integer:

.get_time_year()
==========================================
[source]
------------------------------------------
>>> get_time_year
1989
------------------------------------------
==========================================
________________<heredoc?>________________
function get_time_year() {
    die_if_args
    date +'%Y'
}

declare_function_with_stdin <<'________________<heredoc?>________________'
integer get_time_month(void)

Get the current month as a two-digit 01-based integer:

.get_time_month()
==========================================
[source]
------------------------------------------
>>> get_time_month
11
------------------------------------------
==========================================
________________<heredoc?>________________
function get_time_month() {
    die_if_args
    date +'%m'
}

declare_function_with_stdin <<'________________<heredoc?>________________'
integer get_time_day(void)

Get the current day as a two-digit 01-based integer: e.g.,

.get_time_day()
==========================================
[source]
------------------------------------------
>>> get_time_day
9
------------------------------------------
==========================================
________________<heredoc?>________________
function get_time_day() {
    die_if_args
    date +'%m'
}

#FIXME: Replace explicitly listing weekdays with a compact table.
declare_function_with_stdin <<'________________<heredoc?>________________'
integer get_time_weekday(void)

Get the current weekday as an integer ranging [1, 7] assigned as follows:

.get_time_weekday()
[cols=">,<strong",options="header"]
|===============================================================================
| weekday   | integer
| sunday    | 1
| monday    | 2
| tuesday   | 3
| wednesday | 4
| thursday  | 5
| friday    | 6
| saturday  | 7
|===============================================================================

For example:

.get_time_weekday()
==========================================
[source]
------------------------------------------
# Assuming the current day to be Sunday:
>>> get_time_weekday
1
------------------------------------------
==========================================
________________<heredoc?>________________
function get_time_weekday() {
    # Unlike customary indexing for days, weeks, months, and years, "date"
    # provides days of the week ranging [0, 6]. Increment accordingly.
    die_if_args
    return_string $(( $(date +'%w') + 1 ))
}

declare_function_with_stdin <<'________________<heredoc?>________________'
integer get_time_hour(void)

Get the current hour as a two-digit integer ranging [00, 23]: e.g.,

.get_time_hour()
==========================================
[source]
------------------------------------------
>>> get_time_hour
12
------------------------------------------
==========================================
________________<heredoc?>________________
function get_time_hour() {
    die_if_args
    date +'%H'
}

declare_function_with_stdin <<'________________<heredoc?>________________'
integer get_time_minute(void)

Get the current minute as a two-digit integer ranging [00, 59]: e.g.,

.get_time_minute()
==========================================
[source]
------------------------------------------
>>> get_time_minute
30
------------------------------------------
==========================================
________________<heredoc?>________________
function get_time_minute() {
    die_if_args
    date +'%M'
}

declare_function_with_stdin <<'________________<heredoc?>________________'
integer get_time_second(void)

Get the current second as a two-digit integer ranging [00, 59]: e.g.,

.get_time_second()
==========================================
[source]
------------------------------------------
>>> get_time_second
00
------------------------------------------
==========================================
________________<heredoc?>________________
function get_time_second() {
    die_if_args
    date +'%S'
}

declare_function_with_stdin <<'________________<heredoc?>________________'
integer get_time_nanosecond(void)

Get the current nanosecond as a nine-digit integer ranging
[000000000, 999999999]: e.g.,

.get_time_nanosecond()
==========================================
[source]
------------------------------------------
>>> get_time_nanosecond
554999445
------------------------------------------
==========================================
________________<heredoc?>________________
function get_time_nanosecond() {
    die_if_args
    date +'%N'
}

# ....................{ CONVERTERS ~ seconds               }....................
declare_function_with_stdin <<'________________<heredoc?>________________'
integer convert_weeks_to_seconds(integer weeks)

Convert the passed number of weeks to seconds: e.g.,

.convert_weeks_to_seconds()
==========================================
[source]
------------------------------------------
>>> convert_weeks_to_seconds 42
25401600
------------------------------------------
==========================================
________________<heredoc?>________________
function convert_weeks_to_seconds() {
    die_unless_arg 'expected one number'
    string weeks="${1}"
    die_unless_integer "${weeks}"
    return_string $(( weeks * 7 * 24 * 60 * 60 ))
}

declare_function_with_stdin <<'________________<heredoc?>________________'
integer convert_days_to_seconds(integer days)

Convert the passed number of days to seconds: e.g.,

.convert_days_to_seconds()
==========================================
[source]
------------------------------------------
>>> convert_days_to_seconds 42
3628800
------------------------------------------
==========================================
________________<heredoc?>________________
function convert_days_to_seconds() {
    die_unless_arg 'expected one number'
    string days="${1}"
    die_unless_integer "${days}"
    return_string $(( days * 24 * 60 * 60 ))
}

declare_function_with_stdin <<'________________<heredoc?>________________'
integer convert_hours_to_seconds(integer hours)

Convert the passed number of hours to seconds: e.g.,

.convert_hours_to_seconds()
==========================================
[source]
------------------------------------------
>>> convert_hours_to_seconds 42
151200
------------------------------------------
==========================================
________________<heredoc?>________________
function convert_hours_to_seconds() {
    die_unless_arg 'expected one number'
    string hours="${1}"
    die_unless_integer "${hours}"
    return_string $(( hours * 60 * 60 ))
}

declare_function_with_stdin <<'________________<heredoc?>________________'
integer convert_minutes_to_seconds(integer minutes)

Convert the passed number of minutes to seconds: e.g.,

.convert_minutes_to_seconds()
==========================================
[source]
------------------------------------------
>>> convert_minutes_to_seconds 42
2520
------------------------------------------
==========================================
________________<heredoc?>________________
function convert_minutes_to_seconds() {
    die_unless_arg 'expected one number'
    string minutes="${1}"
    die_unless_integer "${minutes}"
    return_string $(( minutes * 60 ))
}

# ....................{ SETTERS                            }....................
declare_function_with_stdin <<'________________<heredoc?>________________'
void set_time_unix(integer seconds_since_unix_epoch)

Set the current time in seconds since the Unix epoch (January 1st, 1970). Since
setting such time manually is largely discouraged, consider calling
set_time_with_ntp() instead when network access is available.
________________<heredoc?>________________
function set_time_unix() {
    # Validate sanity.
    die_if_args
    string time_unix="${1}"
    die_unless_integer_positive "${time_unix}"

    #FIXME: Blatantly Linux-specific. *sigh*

    # Set the system clock to such time.
    date +%s --set="${time_unix}"

    #FIXME: Considered harmful or helpful? Shouldn't most systems do so on
    #shutdown already?
    # Set the hardware clock from the system clock.
    hwclock --systohc
}

declare_function_with_stdin <<'________________<heredoc?>________________'
void set_time_with_ntp(void)

Synchronize local system time against remote time servers. Generally speaking,
the `ntpd` daemon should perform such synchronization on your behalf in the
background. Hence, call this function only when not running such daemon (which
you really should be) or when such daemon silently fails to run. The default
configuration of `ntpd` makes such failure unfortunately common: under large
clock skew (i.e., local system time desynchronized from remote time servers by
over 15 minutes), the default configuration of `ntpd` silently fails after
roughly 15 seconds of successful operation. In such case, calling this or a
comparable command is the only means of rejuvenating `ntpd`.

Technically, other ways do exist: adding `tinker panic 0` to `/etc/ntp.conf`,
for example, permits `ntpd` to accept any clock slew regardless of size. This
is generally considered bad form, however. Hence, this function.
________________<heredoc?>________________
function set_time_with_ntp() {
    # Validate sanity.
    die_if_args

    #FIXME: Extract into a configuration variable. (It's not POSIX, clearly;
    #perhaps a new "if_config/if_pathable/ntp" configuration file.)
    # Hostname of the default NTP server (typically, a pool of such servers
    # redirecting to the real NTP server "closest" to the caller).
    string default_ntp_server='pool.ntp.org'

    #FIXME: See http://en.gentoo-wiki.com/wiki/Time_Synchronization for
    #additional methods. "htpdate" is quite clever, for example: pass it any
    #HTTP server (e.g., "www.linux.org") and it synchronizes the system time
    #against the server's reported time. Nice!

    # Prefer "ntpd", if installed. "ntpd" is both the authoritative server and
    # client for NTP synchronization.
    if { is_pathable ntpd } {
        # Dismantled, this is:
        #
        # * "-g", accepting arbitrarily large clock skew. Essential.
        # * "-q", exiting after first setting the local system time.
        print_message 'synchronizing via "ntpd"...'
        run_command_with_progress_timer ntpd -g -q
    # Prefer "sntp", if installed. "sntp" is the authoritative client for NTP
    # synchronization on mobile devices.
    } elif { is_pathable sntp } {
        # Dismantled, this is:
        #
        # * "-a", calling adjtime() to slew rather than settimeofday() to skew
        #   the local system time. Whereas skewing often unsafely jumps to the
        #   target time, slewing safely and slowly incrementally approaches the
        #   target time.
        print_message 'synchronizing via "sntp"...'
        sntp -j "${default_ntp_server}"
    # Run a deprecated command, if nothing better is currently installed.
    } elif { is_pathable ntpdate } {
        print_warning '"ntpd" and "sntp" not installed'
        print_message 'synchronizing via "ntpdate"... (deprecated)'
        ntpdate "${default_ntp_server}"
    # Else, throw an exception.
    } else {
        die '"ntpd", "sntp", and "ntpdate" not installed'
    }
}

# ....................{ SLEEPERS                           }....................
#FIXME: Doesn't really belong here. Contemplate a new component "sleep".
declare_function_with_stdin <<'________________<heredoc?>________________'
void sleep_seconds(integer seconds)

Idle the current shell for the passed number of seconds.
________________<heredoc?>________________
function sleep_seconds() {
    # Validate passed arguments.
    die_unless_arg 'expected one nonnegative integer'
    string seconds="${1}"
    die_unless_integer_nonnegative "${seconds}"

    # Sleep for such seconds.
    sleep -- ${seconds}s
}

# --------------------( WASTELANDS                         )--------------------
#FUXME: Rename to simply get_time(), in accordance with current nomenclature
#elsewhere (e.g., get_path_mtime()). To be honest, pretty much
#everything in this component could use a similar rename. *sigh*
    # Assuming get_time_unix() to return "3141592653".
#FUXME: Hmm; declare_function() can't handle function synonyms. *sigh*
# ....................{ TESTERS                            }....................
# boolean is_path_mtime_older_than(void)

# --OR--
# integer get_time_seconds_since_unix_epoch(void)
#   get_time_seconds_since_unix_epoch# string print_current_date_and_time(void)
#
# Print a human-readable synopsis of the current date and time.
#function print_current_date_and_time() {
#    die_if_args
#    date 
#}

#   function testem() { false; return_string 1 }
#   (( $(testem) + 1 ))
#   integer current_time_in_seconds time_modifier_in_seconds
#   (( $(get_time_unix) $(get_hours_as_seconds -6) ))
#   current_time_in_seconds="$(get_time_unix)"
#   time_modifier_in_seconds="$(convert_hours_to_seconds -6)"
#interactive_alias calq="print_calendar_quarter"
#interactive_alias caly="print_calendar_year"
#interactive_alias calyn="print_calendar_year_next"
#FIXME: There exist a variety of alternative command-line applications for
#performing remote time synchronization: "ntpd" is merely the most popular.
#Shift this function to "os/time".

#FIXME: Perhaps some variant of update_system_time_via_ntp(void)?

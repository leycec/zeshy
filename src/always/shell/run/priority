#!/usr/bin/env zsh
# ====================[ priority                           ]====================
#
# --------------------( LICENSE                            )--------------------
# Copyright 2007-2012 by Cecil Curry.
# See "COPYING" for additional details.
#
# --------------------( SYNOPSIS                           )--------------------
# Handle process prioritization.

# ....................{ RUNNERS                            }....................
#FIXME: Rename to run_with_priority_highest().
document_function '
string run_quickly(
  string command_name, string command_arg1, string command_arg2, ...)

Run the passed command "quickly" under prioritized CPU and I/O scheduling.
'
function run_quickly() {
    die_unless_args 'expected one command'
    run_with_priorities\
        ${ZESHY_NICE_PRIORITY_LOW}\
        ${ZESHY_IONICE_CLASS_LOW}\
        ${ZESHY_IONICE_CLASS_PRIORITY_LOW}\
        "${@}"
}

#FIXME: Rename to run_with_priority_lowest().
document_function '
string run_slowly(
  string command_name, string command_arg1, string command_arg2, ...)

Run the passed command "slowly" under deprioritized CPU and I/O scheduling.
'
function run_slowly() {
    die_unless_args 'expected one command'
    run_with_priorities\
        ${ZESHY_NICE_PRIORITY_LOW}\
        ${ZESHY_IONICE_CLASS_LOW}\
        ${ZESHY_IONICE_CLASS_PRIORITY_LOW}\
        "${@}"
}

#FIXME: Rename to run_with_priority() and reorder arguments, accepting such
#command prior to such integers.
document_function '
string run_with_priorities(
  integer nice_priority, integer ionice_class, integer ionice_class_priority,
  string command_name, string command_arg1, string command_arg2, ...)

Run the passed command under the passed "nice" and "ionice" priorities if
"ionice" is under ${PATH} or the passed "nice" priority otherwise.
'
function run_with_priorities() {
    # Validate passed arguments.
    die_unless_args_4_or_more\
        'expected one command, one nice priority, one ionice class, and one ionice class priority'
    string\
        nice_priority="${1}"\
        ionice_class="${2}"\
        ionice_class_priority="${3}"
    #FIXME: Should also ensure such integers to be properly bounded.
    die_unless_string_integers\
        "${nice_priority}" "${ionice_class}" "${ionice_class_priority}"
    behead_args_3

    # Command line to be run, prefixed by commands prioritizing the passed
    # command. All systems provide "nice" but not necessarily "ionice".
    list command_line; command_line=( nice -n${nice_priority} )
    is_pathable ionice and command_line+=( ionice
        -c${ionice_class}
        -n${ionice_class_priority}
    )

    # Run such line.
    command_line+=( "${@}" )
    run "${command_line[@]}"
}

# --------------------( WASTELANDS                         )--------------------

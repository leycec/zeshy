#!/usr/bin/env zsh
# ====================[ system                             ]====================
#
# --------------------( LICENSE                            )--------------------
# Copyright 2007-2012 by Cecil Curry.
# See "COPYING" for additional details.
#
# --------------------( SYNOPSIS                           )--------------------
# Zeshy System, handling system stability.

# ....................{ TESTERS                            }....................
# void test_system(void)
#
# Torture test system stability.
test_system() {
    # Validate sanity.
    die_if_args
    die_unless_interactive

    #FIXME: Add support for the Phoronix test suite, available in ~arch. See:
    #  http://www.phoronix-test-suite.com
    #Add support for "cpuburn". Ohhhh, ya.
    # Find "mprime", if not installed in the $PATH (as under Gentoo).
    string test_command
    if   is_installed 'mprime'
    then test_command='mprime'
    elif is_installed '/opt/gimps/mprime'
    then test_command='/opt/gimps/mprime'
    fi
    die_unless_nonempty "${test_command}" '"mprime" not found in $PATH'

    #FIXME: Spawn "monitor_sensors" ourselves for GUI-driven torture tests?
    #Also, note that "conky" is probably preferable for users installing that.
    # Notify the user of impending heat death.
#   utter 'consider monitoring CPU MCE errors with "mcelog" in another shell.'
    utter 'consider monitoring temperature with "monitor_sensors" in another shell.'
    utter 'if "monitor_sensors" shows an unexpected "ALARM", kill this process.'
#   sputter_blank_line
    ask_any_key "press any key to begin...\n"

    # Torture.
    case "${test_command}" in
        *mprime) "${test_command}" -t -w"$(get_temporary_home)";;
        *) die 'something wicked this way sways';;
    esac
}

#!/usr/bin/env zsh
# ====================[ move                               ]====================
#
# --------------------( LICENSE                            )--------------------
# Copyright 2007-2012 by Cecil Curry.
# See "COPYING" for additional details.
#
# --------------------( SYNOPSIS                           )--------------------
# Handle path movement (i.e., renaming).

# ....................{ PRINTERS                           }....................
#FIXME: Take care when calling this function with "-"-prefixed arguments.
#FIXME: Generalize this function just to accept source pathnames -- exclude the
#final target pathname.
#FIXME: Rename to cry_if_symbolic_link_broken() and shift to "path/link".

document_function '
cry_if_shifted_broken_symbolic_links(
  string source_pathname1, string source_pathname2, ...,
  string target_pathname)

Print a warning for passed source paths that are symbolic links broken by a
copy or move to the passed target path. This is a utility function intended to
be called only by the copy_path_*() and move_path_*() families of functions.
'
function cry_if_shifted_broken_symbolic_links() {
    # Validate passed arguments.
    die_unless_args_2_or_more\
        'expected at least one source pathname and one target pathname'

    #FIXME: Shift into copy_path() and move_path(). *shrug*
    # List of shifted pathnames to be tested for broken symbolic links.
    list shifted_pathnames
    if is_args_2
    then shifted_pathnames=( "${2}" )
    #FIXME: Documentation's a tad off.
    # Dismantled, this is:
    #
    # * "${@[-1]}", expanding to the target pathname. Since at least three paths
    #   were passed and "cp" returned successfully, this is always a dirname.
    # * "${^@[1,-2]:t}", iteratively expanding to the basename for each passed
    #   source pathname.
    else shifted_pathnames=( "${@[-1]}/${^@[1,-2]:t}" )
    fi

    # Print a warning for all shifted paths that are broken symbolic links.
#   print_string "shifted_pathnames: ${shifted_pathnames[*]}"
    for shifted_pathname ("${shifted_pathnames[@]}") {
        is_broken_symbolic_link "${shifted_pathname}" and {
            string target_pathname
            target_pathname="$(get_symbolic_link_target "${shifted_pathname}")"
            cry "symbolic link \"${shifted_pathname}\" target \"${target_pathname}\" not found"
        }
    }

    # If the last shifted path is not a broken symbolic link, the prior
    # conditional returns false. To avoid returning false from this function in
    # such a case, return true...by force!
    return_true
}

# ....................{ MOVERS                             }....................
document_function '
void move_path(string source_pathname, string target_pathname)

Silently move the passed source to target path. If the former does not exist,
throw an exception. If the former is a symbolic link broken after being moved to
the latter, print a warning.
'
function move_path() {
    die_unless_args_2 'expected one source pathname and one target pathname'
    run_with_options_quietly 'command mv' ZESHY_MV_OPTIONS "${(q)@}"
    cry_if_shifted_broken_symbolic_links "${@}"
}

document_function '
void move_path_with_options(
  string mv_option1, string mv_option2, ...,
  string source_pathname1, string source_pathname2, ...,
  string target_pathname)

Move the passed source paths to the target path with both the passed and
currently configured "mv"-specific options. If any source path does not exist,
throw an exception. If any source path is a symbolic link broken after being
moved to the latter, print a warning.
'
function move_path_with_options() {
    die_unless_args_2_or_more\
        'expected at least one source pathname and one target pathname'
    run_with_options_configured 'command mv' ZESHY_MV_OPTIONS "${(q)@}"
    cry_if_shifted_broken_symbolic_links "${@}"
}

# --------------------( WASTELANDS                         )--------------------
# "shallowly" (i.e., moving source symbolic links rather than the targets of such links)

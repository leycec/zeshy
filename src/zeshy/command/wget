#!/usr/bin/env zsh
# ====================[ wget                               ]====================
#                     [ Time-stamp: "2009-04-18 19:29:36 leycec" ]
#
# --------------------( SYNOPSIS                           )--------------------
# Zeshy wget. This Zeshy component handles "wget" functionality.

# ....................{ IMPORTS                            }....................
zimport zeshy/regex

# ....................{ URLS                               }....................
# Aliases.
alias wgetru='wget_resolve_url'

#FIXME: This is also implementable via 'curl -sI "${url}"'.
# char *wget_resolve_url(char *url)
#
# Transitively resolve the passed URL of all intermediary redirects. For
# example, if "http://dieoff.com" redirected to "http://holoceneextinction.com"
# redirected to "http://raiazome.com", then this function prints the final URL,
# "http://raiazome.com".
wget_resolve_url() {
    die_unless_one_argument 'expected exactly one URL'

    # Run "wget" with options:
    #
    # * "-t 1" to prevent retrying, if the first attempt fails.
    # * "--spider" to prevent actual retrieval of page content.
    # * "-O -" to permit redirection to a pipe. 
    #
    # Avoid running under "try" as that currently fails to interpret shell
    # sensitive characters properly (e.g., "&"), and redirect stderr to stdout
    # as *WE HAVE TO* (which seems fairly dumb).
    local url="${1}"
    local wget_output="$(wget --max-redirect=0 --spider --tries=1 -O - "${url}" 2>&1)"
    is_ok || die "\"${url}\" not resolved; \"wget\" failed with:\n${wget_output}"

    # Match the resolved URL from the "wget" output.
    local url_resolved  # separate to capture return code
          url_resolved="$(match_multiline_first_group '^Location: ([^ ]+) ' "${wget_output}")"

    # If the passed URL does redirect to another URL, print that; otherwise,
    # print the URL as is.
    if is_ok
    then print "${url_resolved}"
    else print "${url}"
    fi
}

# --------------------( COPYRIGHT AND LICENSE              )--------------------
# The information below applies to everything in this distribution,
# except where noted.
#              
# Copyright 2007-2011 by Cecil Curry.
#   
#   http://www.raiazome.com
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.

#!/usr/bin/env zsh
# ====================[ wget                               ]====================
#                     [ Time-stamp: "2009-04-18 19:29:36 leycec" ]
#
# --------------------( SYNOPSIS                           )--------------------
# Zeshy wget. This Zeshy component handles "wget" functionality.

# ....................{ IMPORTS                            }....................
zimport zeshy/regex

# ....................{ URLS                               }....................
# char *resolve_url(url)
#
# Transitively resolve the passed URL of all intermediary redirects. For
# example, if "http://dieoff.com" redirected to "http://holoceneextinction.com"
# redirected to "http://raiazome.com", then this function prints the final URL,
# "http://raiazome.com".
resolve_url() {
    [[ "${#}" -eq 1 ]] || die 'expected exactly one URL'

    # Run "wget" with options:
    #
    # * "-t 1" to prevent retrying, if the first attempt fails.
    # * "--spider" to prevent actual retrieval of page content.
    # * "-O -" to permit redirection to a pipe. 
    #
    # Also, redirect stderr to stdout because *WE HAVE TO*. (Yes, this is dumb.)
    try wget -t 1 --spider -O - "${1}" 2>&1 |
        match_multiline_first_group '^Location: ([^ ]+) '
}

# --------------------( COPYRIGHT AND LICENSE              )--------------------
# The information below applies to everything in this distribution,
# except where noted.
#              
# Copyright 2007-2011 by Cecil Curry.
#   
#   http://www.raiazome.com
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.

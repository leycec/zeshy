#!/usr/bin/env zsh
# ====================[ hg                                 ]====================
#                     [ Time-stamp: "2009-04-18 19:29:36 leycec" ]
#
# --------------------( SYNOPSIS                           )--------------------
# Zsh hg. This Zeshy component implements Mercurial-handling functionality.
#
# --------------------( COMMANDS ~ risky                   )--------------------
# Additional commands, for which this script provides no aliases or functions
# due to innate riskiness, include:
#
#     # Revert the repository to the remote master.

# ....................{ ALIASES                            }....................
alias hgdf='hg_list_deleted_files'
alias hgdff='hg_find_deleted_file'
alias hgdfr='hg_recover_deleted_file'

# ....................{ RECOVERY                           }....................
# char *hg_list_deleted_files(void)
#
# List each deleted file in the current Mercurial repository on a separate line,
# formatted:
#
#     "${deleted_filename}" deleted in revision ${revision_number}.
#
# This function is heavily inspired by a related Stackoverflow thread, with
# thanks to dfa and Peter Rowell:
hg_list_deleted_files() {
    [[ ${#} -eq 0 ]] || die 'expected no arguments'
    utter "listing deleted files..."
    try "_hg_list_deleted_files | ${PAGER}"
}

_hg_list_deleted_files() {
    [[ ${#} -eq 0 ]] || die 'expected no arguments'
    try "hg log --template '\"{file_dels}\" deleted in revision {rev}.\n' | grep -v '^\"\"'"
}

# char *hg_find_deleted_file(char *grep_pattern)
#
# Find the deleted file in the current Mercurial repository whose filename
# corresponds to the passed grep pattern.
hg_find_deleted_file() {
    [[ ${#} -eq 1 ]] || die 'expected exactly one grep expression'

    local grep_pattern="${1}"
    utter "finding deleted files matching \"${grep_pattern}\"..."
    _hg_list_deleted_files | grep --color=always '^"${grep_pattern}'
    [[ ${?} -eq 0 ]] || die "not found"
#   is_ok || die "not found"
}

# void hg_recover_deleted_file(int revision_number, char *filename)
#
# Recover the deleted file from the current Mercurial repository corresponding
# to the passed revision of the passed file.
#
# This function is intended to be called after manually calling the 
# hg_find_deleted_file() function (to find the most recent revision number
# having this file).
hg_recover_deleted_file() {
    [[ ${#} -eq 2 ]] ||
        die 'expected exactly one revision number and one filename'

    local revision_number="${1}"
    local deleted_file="${2}"
    utter "recovering ${deleted_file} from revision ${revision_number}..."
    try hg revert -r ${revision_number} "${deleted_file}"
}

# --------------------( COPYRIGHT AND LICENSE              )--------------------
# The information below applies to everything in this distribution,
# except where noted.
#              
# Copyright 2007-2012 by Cecil Curry.
#   
#   http://www.raiazome.com
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.

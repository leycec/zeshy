#!/usr/bin/env zsh
# ====================[ compress                           ]====================
#                     [ Time-stamp: "2009-04-18 19:29:36 leycec" ]
#
# --------------------( SYNOPSIS                           )--------------------
# Zeshy Compress, implementing file compression and decompression functionality.

# ....................{ DEPENDENCIES                       }....................
zimport zeshy/command
zimport zeshy/file/file

# ....................{ DECOMPRESSION                      }....................
# void unpack(char *filename1, char *filename2, ...)
#
# Uncompress one or more compressed files of arbitrary type.
#FIXME: Add ".lzo" and ".lzma" support. Also, offer to install unarchival
#software when needed, if not already installed on the current machine. Also,
#check if software is installed prior to calling external executables. (Doesn't
#simply prefixing, say, "try 7z x "${archive_file}" ;;" suffice?
unpack() {
    die_unless_at_least_one_argument 'expected at least one filename'

    string archive_file
    for archive_file in "${@}"; do
        # Obtain this archive's filetype. This is considerably more complex than it
        # should be, as "sed" seems to be incapable of obeying the following
        # substitution:
        #
        #   ... | sed -r 's/^.+\.(tar\.)?/\1/') 
        #
        # Specifically, "sed" refuses to substitute "\1" with "tar." when the
        # latter is found. If we remove the "?", then it does perform the
        # substitution, but (of course) fails on filenames not having the "tar."
        # extension. This is the best we can do, therefore; and it actually works.
        #
        # Oddly, Zsh also seems incapable of obeying the following PCRE:
        #
        #   ... =~ \.(tar\.)?(.+)
        # 
        # Thus, "sed" hackiness it is.
        string archive_filetype="$(print "${archive_file}" | sed -r 's/^.+\.(tar\.)/tar~/' | sed -r 's/^.+\.//' | sed -r 's/tar~/tar./')"

        # Alias alternative archive filetypes to their canonical filetype.
        case "${archive_filetype}" in
            cbz) archive_filetype="zip" ;;
            jar) archive_filetype="zip" ;;
            tbz) archive_filetype="tar.bz2" ;;
            tgz) archive_filetype="tar.gz" ;;
        esac

        case "${archive_filetype}" in
            7z)
                utter "un7ziping \"${archive_file}\"..."
                7z x "${archive_file}" ;;
            bz|bz2)
                utter "unbzip2ing \"${archive_file}\"..."
                bunzip2 --keep "${archive_file}" ;;
            rar)
                utter "unraring \"${archive_file}\"..."
                unrar x "${archive_file}" ;;
            tar)
                utter "untaring \"${archive_file}\"..."
                tar -xvf "${archive_file}" ;;
            tar.bz2)
                utter "untaring \"${archive_file}\"..."
                tar -xvjf "${archive_file}" ;;
            tar.gz)
                utter "untaring \"${archive_file}\"..."
                tar -xvzf "${archive_file}" ;;
            tar.lzma|tar.xz)
                utter "untaring \"${archive_file}\"..."
                tar -xvJf "${archive_file}" ;;
            gz)
                utter "ungziping \"${archive_file}\"..."
                gunzip "${archive_file}" --to-stdout > "${archive_file%.gz}";;
            lzma|xz)
                utter "unxziping \"${archive_file}\"..."
                unxz "${archive_file}" ;;
            zip)
                utter "unziping \"${archive_file}\"..."
                unzip "${archive_file}" ;;
            *) die "${archive_filetype} for \"${archive_file}\" not a recognized archive filetype" ;;
        esac
    done
}

# ....................{ HELPERS                            }....................
# void archive_dir(char *dirname, char *filetype,
#     char *archive_command, char *archive_command_options, 
#     char *archive_list_command, char *archive_list_command_options)
#
# Archive the passed directory into a file of the passed filetype via the passed
# archive command. This function is a helper intended to be called only by other
# Zeshy components (e.g., "command/bzip2").
archive_dir() {
    is ${#} -eq 8 si or
        die 'expected exactly one dirname, filetype, archive command and options, and list command and options'

    # Strip trailing '/' characters from the passed dirname, if present.
    string dirname="${1%/}" filetype="${2}"\
        archive_command="${3}"\
        archive_command_pre_options="${4}"\
        archive_command_post_options="${5}"\
        archive_list_command="${6}"\
        archive_list_command_pre_options="${7}"\
        archive_list_command_post_options="${8}"

    # Ensure sanity.
    die_unless_dir "${dirname}"
    
    string filename="${dirname}.${filetype}"
    utter "archiving \"${filename}\"..."
#   print "${archive_command} ${archive_command_pre_options} \"${filename}\" \"${dirname}\" ${archive_command_post_options}"
    ${archive_command} ${(z)archive_command_pre_options} "${filename}" "${dirname}"
                       ${(z)archive_command_post_options}

    print
    utter "listing \"${filename}\"..."
    ${archive_list_command} ${(z)archive_list_command_pre_options} "${filename}"\
                            ${(z)archive_list_command_post_options}
}

#FIXME: Revise to coincide with archive_dir(). Improve documentation.
# Creates an archive of arbitrary type and command.
archive_file() {
    if [[ -n "${1}" && -f "${1}" ]]; then
        # Remove this path's trailing '/', if it has such a trailing '/'.
        2=$(echo "${1}" | sed --regexp-extended 's/\.[^.]+$/.'${2}'/' -)
        
        utter "creating \"${2}\"..."
        ${3} ${4} "${2}" "${1}"

        echo ""
        utter "listing \"${2}\"..."
        ${5} ${6} "${2}"
    elif is_empty    "${1}"; then die "no path passed"
    elif not is_file "${1}"; then die "\"${1}\" not a file"
    fi
}

#FIXME: Obsolete.
# char *bzcat_page(char *bzcat_option1, char *bzcat_option2, ...)
#
# Print the passed bz2-compressed filename under the current pager.
#bzcat_page() {
#    zpage bzcat "${@}"
#}

# --------------------( COPYRIGHT AND LICENSE              )--------------------
# The information below applies to everything in this distribution,
# except where noted.
#              
# Copyright 2007-2012 by Cecil Curry.
#   
#   http://www.raiazome.com
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.

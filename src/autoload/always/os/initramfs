#!/usr/bin/env zsh
# ====================[ initramfs                          ]====================
#
# --------------------( SYNOPSIS                           )--------------------
# Zeshy Initramfs, implementing initial RAM filesystem handling.

# ....................{ WRITERS                            }....................
# void install_initramfs(
#   char *initramfs_home = ${ZESHY_INITRAMFS_HOME},
#   char *kernel_home = get_kernel_home())
#
# Reinstall the passed initramfs (defaulting to ${ZESHY_INITRAMFS_HOME}) to the
# /boot partition as "/boot/initramfs-${kernel_version}.img", a filename format
# implicitly expected by GRUB2, where ${kernel_version} is the version of the
# passed kernel (defaulting to "/usr/src/linux").
install_initramfs() {
    # Localize and validate passed arguments.
    die_unless_at_most_two_args\
        'expected optional initramfs and kernel dirnames'
    string initramfs_home kernel_home
    initramfs_home="${1:-${ZESHY_INITRAMFS_HOME}}"
    kernel_home="${2:-$(get_kernel_home)}"
    die_unless_dir "${initramfs_home}"

    # Mount the "/boot" partition writably.
    mount_writable_boot_dir

    # Reinstall the passed initramfs. Obtain the absolute path of its image only
    # after rebuilding the kernel, above.
    string kernel_version initramfs_image
    kernel_version="$(get_kernel_version "${kernel_home}")"
    initramfs_image="/boot/initramfs-${kernel_version}.img"
    interactively utter "(re)installing \"${initramfs_home}/\"..."
    remove_path "${initramfs_image}"
    find "${initramfs_home}" |
        cpio --quiet -o -H newc |
        gzip -9 > "${initramfs_image}"

    # If interactive, display the installed initramfs for verification.
    interactively print_path_verbosely "${initramfs_image}"
}
    
#FIXME: Obsolete.
# ....................{ GETTERS ~ current                  }....................
#FIXME: Blatantly Linux-specific. Generalize us up.
# char *get_kernel_home(void)
#
# Get the absolute path of the root directory for the current kernel: e.g.,
#
#     >>> get_kernel_home
#     /usr/src/linux
#get_initramfs_home() {
#    die_if_args
#    utter_raw      "${ZESHY_INITRAMFS_HOME}"
#}

# --------------------( COPYRIGHT AND LICENSE              )--------------------
# The information below applies to everything in this distribution,
# except where noted.
#              
# Copyright 2007-2012 by Cecil Curry.
#   
#   http://www.raiazome.com
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.

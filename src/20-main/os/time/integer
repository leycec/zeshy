#!/usr/bin/env zsh
# --------------------( LICENSE                            )--------------------
# Copyright 2007-2013 by Cecil Curry.
# See "COPYING" for additional details.

:parcel <<'-/-'
Handle system time in integer format.
-/-

# ....................{ GETTERS                            }....................
# ....................{ GETTERS ~ period                   }....................
declare_function_with_stdin <<'/---'
integer get_time_century()

Get the current century as a two-digit integer:

.get_time_century()
==========================================
[source]
------------------------------------------
>>> get_time_century
20
------------------------------------------
==========================================
/---
function get_time_century() {
    die_if_args
    date +'%C'
}

declare_function_with_stdin <<'/---'
integer get_time_year()

Get the current year as a four-digit integer:

.get_time_year()
==========================================
[source]
------------------------------------------
>>> get_time_year
1989
------------------------------------------
==========================================
/---
function get_time_year() {
    die_if_args
    date +'%Y'
}

declare_function_with_stdin <<'/---'
integer get_time_month()

Get the current month as a two-digit 01-based integer:

.get_time_month()
==========================================
[source]
------------------------------------------
>>> get_time_month
11
------------------------------------------
==========================================
/---
function get_time_month() {
    die_if_args
    date +'%m'
}

declare_function_with_stdin <<'/---'
integer get_time_day()

Get the current day as a two-digit 01-based integer: e.g.,

.get_time_day()
==========================================
[source]
------------------------------------------
>>> get_time_day
9
------------------------------------------
==========================================
/---
function get_time_day() {
    die_if_args
    date +'%m'
}

#FIXME: Replace explicitly listing weekdays with a compact table.
declare_function_with_stdin <<'/---'
integer get_time_weekday()

Get the current weekday as an integer ranging [1, 7] assigned as follows:

.get_time_weekday()
[cols=">,<strong",options="header"]
|===============================================================================
| weekday   | integer
| sunday    | 1
| monday    | 2
| tuesday   | 3
| wednesday | 4
| thursday  | 5
| friday    | 6
| saturday  | 7
|===============================================================================

For example:

.get_time_weekday()
==========================================
[source]
------------------------------------------
# Assuming the current day to be Sunday:
>>> get_time_weekday
1
------------------------------------------
==========================================
/---
function get_time_weekday() {
    # Unlike customary indexing for days, weeks, months, and years, "date"
    # provides days of the week ranging [0, 6]. Increment accordingly.
    die_if_args
    return_string $(( $(date +'%w') + 1 ))
}

declare_function_with_stdin <<'/---'
integer get_time_hour()

Get the current hour as a two-digit integer ranging [00, 23]: e.g.,

.get_time_hour()
==========================================
[source]
------------------------------------------
>>> get_time_hour
12
------------------------------------------
==========================================
/---
function get_time_hour() {
    die_if_args
    date +'%H'
}

declare_function_with_stdin <<'/---'
integer get_time_minute()

Get the current minute as a two-digit integer ranging [00, 59]: e.g.,

.get_time_minute()
==========================================
[source]
------------------------------------------
>>> get_time_minute
30
------------------------------------------
==========================================
/---
function get_time_minute() {
    die_if_args
    date +'%M'
}

declare_function_with_stdin <<'/---'
integer get_time_second()

Get the current second as a two-digit integer ranging [00, 59]: e.g.,

.get_time_second()
==========================================
[source]
------------------------------------------
>>> get_time_second
00
------------------------------------------
==========================================
/---
function get_time_second() {
    die_if_args
    date +'%S'
}

declare_function_with_stdin <<'/---'
integer get_time_nanosecond()

Get the current nanosecond as a nine-digit integer ranging
[000000000, 999999999]: e.g.,

.get_time_nanosecond()
==========================================
[source]
------------------------------------------
>>> get_time_nanosecond
554999445
------------------------------------------
==========================================
/---
function get_time_nanosecond() {
    die_if_args
    date +'%N'
}

# ....................{ CONVERTERS ~ seconds               }....................
declare_function_with_stdin <<'/---'
integer convert_weeks_to_seconds(integer weeks)

Convert the passed number of weeks to seconds: e.g.,

.convert_weeks_to_seconds()
==========================================
[source]
------------------------------------------
>>> convert_weeks_to_seconds 42
25401600
------------------------------------------
==========================================
/---
function convert_weeks_to_seconds() {
    die_unless_arg 'expected one number'
    string weeks="${1}"
    :die_unless_int "${weeks}"
    return_string $(( weeks * 7 * 24 * 60 * 60 ))
}

declare_function_with_stdin <<'/---'
integer convert_days_to_seconds(integer days)

Convert the passed number of days to seconds: e.g.,

.convert_days_to_seconds()
==========================================
[source]
------------------------------------------
>>> convert_days_to_seconds 42
3628800
------------------------------------------
==========================================
/---
function convert_days_to_seconds() {
    die_unless_arg 'expected one number'
    string days="${1}"
    :die_unless_int "${days}"
    return_string $(( days * 24 * 60 * 60 ))
}

declare_function_with_stdin <<'/---'
integer convert_hours_to_seconds(integer hours)

Convert the passed number of hours to seconds: e.g.,

.convert_hours_to_seconds()
==========================================
[source]
------------------------------------------
>>> convert_hours_to_seconds 42
151200
------------------------------------------
==========================================
/---
function convert_hours_to_seconds() {
    die_unless_arg 'expected one number'
    string hours="${1}"
    :die_unless_int "${hours}"
    return_string $(( hours * 60 * 60 ))
}

declare_function_with_stdin <<'/---'
integer convert_minutes_to_seconds(integer minutes)

Convert the passed number of minutes to seconds: e.g.,

.convert_minutes_to_seconds()
==========================================
[source]
------------------------------------------
>>> convert_minutes_to_seconds 42
2520
------------------------------------------
==========================================
/---
function convert_minutes_to_seconds() {
    die_unless_arg 'expected one number'
    string minutes="${1}"
    :die_unless_int "${minutes}"
    return_string $(( minutes * 60 ))
}

# ....................{ SETTERS                            }....................
#FIXME: Rename to set_time().
declare_function_with_stdin <<'/---'
void set_time_unix(integer seconds_since_unix_epoch)

Set the current time in seconds since the Unix epoch (January 1st, 1970). Since
setting such time manually is largely discouraged, consider calling
set_time_with_ntp() instead when network access is available.
/---
function set_time_unix() {
    # Validate sanity.
    die_if_args
    string time_unix="${1}"
    :die_unless_int_positive "${time_unix}"

    #FIXME: Blatantly Linux-specific. *sigh*

    # Set the system clock to such time.
    command date +%s --set="${time_unix}"

    #FIXME: Considered harmful or helpful? Shouldn't most systems do so on
    #shutdown already?
    # Set the hardware clock from the system clock.
    command hwclock --systohc
}

#FIXME: Rename to set_time_with_ntp().
declare_function_with_stdin <<'/---'
void set_time_with_ntp()

Synchronize local system time against remote time servers. Generally speaking,
the `ntpd` daemon should perform such synchronization on your behalf in the
background. Hence, call this function only when not running such daemon (which
you really should be) or when such daemon silently fails to run. The default
configuration of `ntpd` makes such failure unfortunately common: under large
clock skew (i.e., local system time desynchronized from remote time servers by
over 15 minutes), the default configuration of `ntpd` silently fails after
roughly 15 seconds of successful operation. In such case, calling this or a
comparable command is the only means of rejuvenating `ntpd`.

Technically, other ways do exist: adding `tinker panic 0` to `/etc/ntp.conf`,
for example, permits `ntpd` to accept any clock slew regardless of size. This
is generally considered bad form, however. Hence, this function.
/---
function set_time_with_ntp() {
    # Validate sanity.
    die_if_args

    #FIXME: Extract into a configuration variable. (It's not POSIX, clearly;
    #perhaps a new "if_config/time" configuration file.)

    # Hostname of the default NTP server (typically, a pool of such servers
    # redirecting to the real NTP server "closest" to the caller).
    string default_ntp_server='pool.ntp.org'

    #FIXME: See http://en.gentoo-wiki.com/wiki/Time_Synchronization for
    #additional methods. "htpdate" is quite clever, for example: pass it any
    #HTTP server (e.g., "www.linux.org") and it synchronizes the system time
    #against the server's reported time. Nice, assuming the same time zone.

    # Prefer "ntpd", if installed. "ntpd" is both the authoritative server and
    # client for NTP synchronization.
    if { is_pathable ntpd } {
        # Dismantled, this is:
        #
        # * "-g", accepting arbitrarily large clock skew. Essential.
        # * "-q", exiting after first setting the local system time.
        print_message_item 'synchronizing via "ntpd"...'
        run_code_with_progress_timer 'ntpd -g -q'
    # Prefer "sntp", if installed. "sntp" is the authoritative client for NTP
    # synchronization on mobile devices.
    } elif { is_pathable sntp } {
        # Dismantled, this is:
        #
        # * "-a", calling adjtime() to slew rather than settimeofday() to skew
        #   the local system time. Whereas skewing often unsafely jumps to the
        #   target time, slewing safely and slowly incrementally approaches the
        #   target time.
        print_message_item 'synchronizing via "sntp"...'
        command sntp -j "${default_ntp_server}"
    # Run a deprecated command, if nothing better is currently installed.
    } elif { is_pathable ntpdate } {
        print_warning '"ntpd" and "sntp" not installed'
        print_message_item 'synchronizing via "ntpdate"... (deprecated)'
        command ntpdate "${default_ntp_server}"
    # Else, throw an exception.
    } else {
        die '"ntpd", "sntp", and "ntpdate" not installed'
    }
}

# ....................{ SLEEPERS                           }....................
#FIXME: Doesn't really belong here. Contemplate a new component "sleep".
declare_function_with_stdin <<'/---'
void sleep_seconds(integer seconds)

Idle the current shell for the passed number of seconds.
/---
function sleep_seconds() {
    # Validate passed arguments.
    die_unless_arg 'expected one nonnegative integer'
    string seconds="${1}"
    :die_unless_int_nonnegative "${seconds}"

    # Sleep for such seconds.
    sleep -- ${seconds}s
}

# --------------------( WASTELANDS                         )--------------------
#declare_function_with_stdin <<'/---'
#integer get_time()
#
#Get the current time in seconds since the Unix epoch (January 1st, 1970): e.g.,
#
#.get_time()
#==========================================
#[source]
#------------------------------------------
#>>> get_time
#3141592653
#------------------------------------------
#==========================================
#/---
#function get_time() {
#    die_if_args
#    date +'%s'
#}

#FUXME: Rename to simply get_time(), in accordance with current nomenclature
#elsewhere (e.g., get_path_mtime()). To be honest, pretty much
#everything in this component could use a similar rename. *sigh*
    # Assuming get_time() to return "3141592653".
#FUXME: Hmm; declare_function() can't handle function synonyms. *sigh*
# ....................{ TESTERS                            }....................
# boolean is_path_mtime_older_than()

# --OR--
# integer get_time_seconds_since_unix_epoch()
#   get_time_seconds_since_unix_epoch# string print_current_date_and_time()
#
# Print a human-readable synopsis of the current date and time.
#function print_current_date_and_time() {
#    die_if_args
#    date 
#}

#   function testem() { false; return_string 1 }
#   (( $(testem) + 1 ))
#   integer current_time_in_seconds time_modifier_in_seconds
#   (( $(get_time) $(get_hours_as_seconds -6) ))
#   current_time_in_seconds="$(get_time)"
#   time_modifier_in_seconds="$(convert_hours_to_seconds -6)"
#alias_cli calq="print_calendar_quarter"
#alias_cli caly="print_calendar_year"
#alias_cli calyn="print_calendar_year_next"
#FIXME: There exist a variety of alternative command-line applications for
#performing remote time synchronization: "ntpd" is merely the most popular.
#Shift this function to "os/time".

#FIXME: Perhaps some variant of update_system_time_via_ntp()?

#!/usr/bin/env zsh
# --------------------( LICENSE                            )--------------------
# Copyright 2007-2013 by Cecil Curry.
# See "COPYING" for additional details.

declare_parcel_as_script_with_stdin <<'/---'
Handle *text file setters* (i.e., functions setting variables to text file
metadata and/or content).
/---

# ....................{ SETTERS                            }....................
declare_function_with_stdin <<'/---'
void set_string_to_file_text(string list_name, string filename)

Set the passed string to the contents of the passed text file: e.g.,

.set_string_to_file_text()
==========================================
[source]
------------------------------------------
>>> string on_short_lives on_generalized_nastiness=\
...    "Crowley had always known that he would be around when the world ended,
...     because he was immortal and wouldn't have any alternative. But he'd
...     hoped it would be a long way off.
...     Because he rather liked people. It was a major failing in a demon.
...     Oh, he did his best to make their short lives miserable, because that
...     was his job, but nothing he could think up was half as bad as the stuff
...     they thought up themselves. They seemed to have a talent for it. It was
...     built into the design, somehow. They were born into a world that was
...     against them in a thousand little ways, and then devoted most of their
...     energies to making it worse. Over the years Crowley had found it
...     increasingly difficult to find anything demonic to do which showed up
...     against the natural background of generalized nastiness. There had been
...     times, over the past millennium, when he'd felt like sending a message
...     back Below saying, Look, we may as well give up right now, we might as
...     well shut down Dis and Pandemonium and everywhere and move up here,
...     there's nothing we can do to them that they don't do themselves and they
...     do things we've never even thought of, often involving electrodes.
...     They've got what we lack. They've got imagination. And electricity, of
...     course.
...     One of them had written it, hadn't he . . . \"Hell is empty, and all the
...     devils are here.\""
>>> write_file_with_string  on_empty_hell "${on_generalized_nastiness}"
>>> set_string_to_file_text on_short_lives on_empty_hell
>>> get_string_line "${on_short_lives}" -1
devils are here."
------------------------------------------
==========================================
/---
function set_string_to_file_text() {
    # Validate sanity.
    die_unless_args_2 'Expected one string name and one filename.'
    string string_name="${1}" filename
    :die_unless_var_string "${string_name}"

    # Canonicalize such file. See get_file_text() for further details.
    :set_string_to_path_canonical filename "${2}"
    die_unless_file_text "${filename}"

    # Set such string to such file's contents.
    run_code_with_mapfile: ${string_name}'="${mapfile[${filename}]}"'
}

declare_function_with_stdin <<'/---'
void set_list_to_file_text_lines(string list_name, string filename)

Set the passed list to the contents of the passed text file split on newlines:
e.g.,

.set_list_to_file_text_lines()
==========================================
[source]
------------------------------------------
>>> string on_satanism=\
...    "Most of the members of the convent were old-fashioned Satanists, like
...     their parents and grandparents before them. They'd been brought up to
...     it and weren't, when you got right down to it, particularly evil. Human
...     beings mostly aren't. They just get carried away by new ideas, like
...     dressing up in jackboots and shooting people, or dressing up in white
...     sheets and lynching people, or dressing up in tie-dye jeans and playing
...     guitars at people. Offer people a new creed with a costume and their
...     hearts and minds will follow. Anyway, being brought up as a Satanist
...     tended to take the edge off it. It was something you did on Saturday
...     nights. And the rest of the time you simply got on with life as best you
...     could, just like everyone else."
>>> list on_creeds
>>> write_file_with_string on_costumes "${on_satanism}"
>>> set_list_to_file_text_lines on_creeds on_costumes
>>> print_string "${on_creeds[5]}"
dressing up in jackboots and shooting people, or dressing up in white
------------------------------------------
==========================================
/---
function set_list_to_file_text_lines() {
    # Validate sanity.
    die_unless_args_2 'Expected one list name and one filename.'
    string list_name="${1}" filename
    die_unless_list "${list_name}"

    # Canonicalize such file. See get_file_text() for further details.
    :set_string_to_path_canonical filename "${2}"
    die_unless_file_text "${filename}"

    # Split such file's contents on newlines into such list. For efficiency,
    # inline such implementation. See set_list_to_string_split_on_newline() for
    # further details.
    run_code_with_mapfile: ${list_name}'=( ${(z)mapfile[${filename}]} )'
}

# ....................{ SETTERS ~ dir                      }....................
declare_function_with_stdin <<'/---'
void set_list_to_dir_files_text(string list_name, string dirname)

Set the passed list to all text files directly in the passed directory.
/---
function set_list_to_dir_files_text() {
    # Validate sanity.
    die_unless_args_2 'Expected one list name and one dirname.'
    string list_name__sltdft="${1}" dirname__sltdft="${2}"
    die_unless_list "${list_name__sltdft}"
    die_unless_dir "${dirname__sltdft}"

    # Set such list. For efficiency, manually implement the test for such glob
    # qualifier. See get_file_encoding() and is_file_binary() for further
    # details. Dismantled, this is:
    #
    # * "-", resolving symbolic links to their transitive targets.
    # * ".", excluding non-plain files.
    # * "e{...}", excluding all files for which such test evaluates to false
    #   (i.e., binary files).
    :set_list_to_glob_qualified_paths\
        "${list_name__sltdft}" "${dirname__sltdft}/*"\
        "-.e:'[[ \$(file --brief --mime-encoding '\${REPLY}') != binary ]]':"
}

# --------------------( WASTELANDS                         )--------------------

#!/usr/bin/env zsh
# ====================[ grub2-install                      ]====================
#
# --------------------( LICENSE                            )--------------------
# Copyright 2007-2012 by Cecil Curry.
# See "COPYING" for additional details.
#
# --------------------( SYNOPSIS                           )--------------------
# Handle GRUB2, a Linux boot loader.

# ....................{ INSTALLERS                         }....................
# void install_grub2_to_mbr(string device_filename = '/dev/sda')
#
# Install GRUB2 to the Master Boot Record (MBR) of the passed disk.
function install_grub2_to_mbr() {
    # Validate passed arguments.
    die_unless_no_or_one_arg 'expected one device filename'
    string device_filename="${1:-/dev/sda}"
    die_unless_disk "${device_filename}"

    #FIXME: The disk should probably be unmounted, no?
#   die_if_mounted_disk "${device_filename}"

    # If interactively confirmed, install GRUB2.
    ask_boolean_strongly\
        "really overwrite the Master Boot Record (MBR) of \"${device_filename}\" with GRUB2?" and {
        mount_writable_boot_dir
        grub2-install "${device_filename}"
    }
}

# ....................{ MAKERS                             }....................
#FIXME: It'd be nice to add an "always" block unmounting "/boot" if unmounted
#before entering this function, both to preserve security and user expectations.

# void make_grub2_boot(void)
#
# Update the current kernel, initramfs, and GRUB2 installation to reflect
# recent system changes (e.g., kernel upgrades). Specifically, in order:
#
# * Rebuild and reinstall the current kernel (e.g., "/usr/src/linux") to
#   "/boot/kernel-${kernel_version}".
# * Reinstall the current initramfs (defined by ${ZESHY_INITRAMFS_HOME}) to
#   "/boot/initramfs-${kernel_version}.img", if such directory exists.
# * Update the GRUB2 configuration file "/boot/grub2/grub.cfg" accordingly.
function make_grub2_boot() {
    # Validate sanity.
    die_if_args
#   interactively say 'updating "/boot"...'

    # Update kernel installation.
    make_kernel

    # Update initramfs installation, if available.
    is_dir "${ZESHY_INITRAMFS_HOME}" and {
        output_newline
        make_initramfs
    }

    # Update GRUB2.
    output_newline
    make_grub2_boot_config_file
}

# void make_grub2_boot_config_file(void)
#
# Update the GRUB2 configuration file on the "/boot" partition to reflect the
# set of all currently installed scripts and kernel and initramfs images.
function make_grub2_boot_config_file() {
    # Validate sanity.
    die_if_args

    #FIXME: Rename to mount_boot_dir_writable().
    # Mount the "/boot" partition writably.
    mount_writable_boot_dir

    # Update the GRUB2 configuration file.
    string grub2_config_file='/boot/grub2/grub.cfg'
    interactively say "making \"${grub2_config_file}\"..."
    grub2-mkconfig -o "${grub2_config_file}"
}

# --------------------( WASTELANDS                         )--------------------
# Update the GRUB2 installation on the "/boot" partition or install GRUB2 on
# such partition if not previously with the current GRUB2 configuration.
# provides a one-stop-shop to
# updating the system after a change (e.g.,
# machine to reflect recent kernel, initramfs,
# and/or GRUB2 changes (e.g., kernel upgrades).
#
# Update the GRUB2 configuration file and install all images such file expects.
#
# Specifically, in order:
# Assuming the current kernel, optional initramfs, and GRUB2 installation to be
# properly configured, this function seemlessly updates the current machine to reflect
# recent changes (e.g., kernel upgrades, initramfs edits).

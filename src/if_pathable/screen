#!/usr/bin/env zsh
# ====================[ screen                             ]====================
#
# --------------------( LICENSE                            )--------------------
# Copyright 2007-2013 by Cecil Curry.
# See "COPYING" for additional details.
#
# --------------------( SYNOPSIS                           )--------------------
# Handle "screen", a shell multiplexer.

# ....................{ ALIASES                            }....................
interactive_substitution {sc}reen='screen -U'
interactive_abbreviation {sc}reen{r}eattach='reattach_screen_session'

# ....................{ GETTERS                            }....................
declare_function '
integer get_screen_session_count(string session_name)

Get the number of "screen" sessions with the passed name.
'
function get_screen_session_count() {
    # Validate passed arguments.
    die_unless_arg 'expected one session name'
    string session_name="${1}"

    #FIXME: Horrible. Use a glob.
    # Count matching sessions.
    screen -list |
        get_string_pcre_multiline_match_count "^\.${session_name}[[:space:]]"
}

# ....................{ PRINTERS                           }....................
declare_function '
string print_screen_sessions(void)

Print all screen sessions attached to the current user.
'
function print_screen_sessions() {
    die_if_args
    screen -list
}

# ....................{ MUNGERS                            }....................
declare_function '
void remove_screen_dead_sessions(void)

Remove all dead (i.e., destroyed, killed, zombie) "screen" sessions.
'
function remove_screen_dead_sessions() {
    # Validate passed arguments.
    die_if_args
    string username; username="${1:-$(get_user)}"

    # Remove such sessions. Avoid "screen -wipe" returning non-zero exit status
    # when no such sessions exist.
    run_command_silent screen -wipe or true
}

declare_function '
void reattach_screen_session(string session_name)

Reattach (i.e., display) the passed detached "screen" session.
'
function reattach_screen_session() {
    die_unless_arg 'expected one screen session name'
    screen -d -a -A -r -- "${1}"
}

# ....................{ RUNNERS                            }....................
declare_function '
void screenify(
  string command_name, string command_arg1, string command_arg2, ...)

Screenify the passed command. Specifically:

* If a screen session with name the basename of the passed command is attached
  to the current user, reattach such session.
* Else, attach a new screen session with such name running such command.
'
function screenify() {
    # Validate passed arguments.
    die_unless_args 'expected one command'
    string command="${@}" session_name
    session_name="$(get_path_basename "$(get_string_word "${command}" 1)")"

    # Locate "screen" and check whether or not a session already exists.
#   string screen=$(which_command screen)
    integer session_count
    session_count="$(get_screen_session_count "${session_name}")"
#   print_message "session_count: ${session_count}"

    # screen's argument passing engine is a wee faulty. Order is important in
    # the argument list below, therefore.
    if (( session_count == 0 )); then
#       print_message_interactively "attaching ${session}..."
        screen -m -fa -U -S "${session}" "${command}"
    elif (( session_count == 1 )); then
#       print_message_interactively "reattaching ${session}..."
        screen -d -a -A -r "${session}"
    else die "${session_count} \"${session}\" screen sessions already started"
    fi
}

# --------------------( WASTELANDS                         )--------------------
#FUXME: The current approach of individial functions accepting the user to run
#such function under as an optional argument is simply *HORRIBLE*. No, really.
#Extending this approach to the entire Zeshy codebase is the very definition of
#reductio ad absurdum. Instead, it should be the *CALLER'S* responsibility to
#call such functions under the desired users if they so choose. Undo this
#nonsense *IMMEDIATELY* please. (kthx.)

#FUXME: Unconvinced "reattach" is an appropriate verb here. How about simply
#"reattach", which is the verb most multiplexers use?
#       get_string_line_match_count "^.${session_name}[[:space:]]"
#   screen_session_count="$(run_command_as_user "${screen_username}" 'screen -list' | get_string_line_match_count ".${screen_session_name}[[:space:]]")"
    #FUXME: Call get_string_pcre_multiline_match_count() here rather than "grep".
#   screen_session_count="$(run_command_as_user "${screen_username}" "screen -list | grep --count '\.${screen_session}[[:space:]]'")"
